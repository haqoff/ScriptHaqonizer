# ScriptHaqonizer
Представляет собой консольную утилиту, с помощью которой можно автоматизировать цикл проверки и деплоя скриптов миграций.
Поддерживает бэкап баз данных с автоматическим вычислением затроных баз, валидацию синтаксиса и проверку исполнения скриптов. Таким образом, утилиту можно внедрить на этап CI/CD для проверки поставляемых скриптов, а также выполнения их на нужной среде.

### Концепция работы:
1. Скрипты складываются в нужную папку с определенным именем. Имя включает в себя разные параметры, например: среды окружения, в которых должен исполняться скрипт.
2. На этапе CI/CD (например, при PR или Merge в DEV/MASTER) происходит запуск утилиты, которая вычисляет новые скрипты, которые нужно выполнить в данном окружении.
3. Если это PR, выполнить валидацию синтаксиса скрипта, а также попробовать запустить скрипт, с последующим откатом транзакции. 
4. Если это Merge, выполнить бэкап затронутых баз данных, а затем выполнить новые скрипты.

### Правила наименования скриптов.
Шаблон: *ID_MigrationName[_Environments][_Params]*

Где:

**ID - уникальный идентификатор скрипта.**
<br/>
Начинается с 1. С каждым скриптом должен увеличиваться. Разница увеличения не имеет значения.
<br/>
Именно в порядке увеличения идентификатора происходит выполнение скриптов. 

**MigrationName - имя миграции в ASCII. От 3 до 50 символов.**

**Environments - параметры окружения скрипта.**
<br/>
Поддерживаемые среды: *Local, Development, Integration, Staging, Loading, Prelive, Production*.
<br/>
Восклицательный знак в начале означает исключение указанных сред. Например, *!Local&Development* означает, что скрипт будет выполняться везде, кроме Local и Development окружений.
Если параметры окружения не указаны, скрипт будет выполняться везде.

**Params - дополнительные параметры выполнения.**
* NoCheck - признак того, что в режиме проверки не нужно выполнять скрипт с последующим откатом транзакции.
<br/>
По умолчанию, если консоль запущена в OnlyCheck режиме, для всех новых скриптов будет попытка их выполнения, а после выполнения будет откат транзакции.
Таким образом, проверяется фактическая возможность исполнения скриптов.
Данный же параметр, отключает такую проверку и может пригодится, если скрипт тяжеловестный и генерирует большой транзакционный лог.
При этом валидация синтаксиса скрипта будет выполняться по прежнему.
* NoTransaction - признак того, что процесс выполнения скрипта не нужно оборачивать в транзакцию.
<br/>
По умолчанию, каждый скрипт выполняется в транзакции.
Может пригодиться для выражений, которые не поддерживают транзакции. Например, в MSSQL - это CREATE DATABASE.
Данный параметр также отключает проверку, описанную в параметре NoCheck, так как она происходит с применением транзакции.
* NoBackup - признак того, что для данного скрипта не нужно выполнять бэкап базы данных перед его применением.
<br/>
По умолчанию, если бэкап включен, перед запуском всех скриптов происходит вычисление всех существующих баз данных, которые были затронуты новыми скриптами, а затем происходит их бэкап.
Данный параметр исключает указанный скрипт из процесса бэкапирования.

Параметры объединяются символом &

Примеры названий:
* 1_AddNewColumn.sql
* 1_AddNewSqlJob_!local.sql
* 1_AddDatabase_NoTransaction.sql
* 3_AddNewRole_Development&Production_Nobackup
* 4_AddDataFromExternalDevDb_Development_NoCheck&NoBackup

### Параметры запуска консоли.

| Краткое имя | Длинное имя                        | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Обязателен |
|-------------|------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------|
| -c          | --connectionString                 | Строка подключения к базе данных. Пользователь должен иметь все права, необходимые для изменения объектов базы данных.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Да         |
| -d          | --databaseName                     | Имя базы данных, в которой хранится история исполненных скриптов. Причём, база данных (как и таблица истории) необязательно должна быть создана на момент запуска консоли. Её можно создать из скриптов.                                                                                                                                                                                                                                                                                                                                                                                                                                                | Да         |
| -s          | --scriptDirectoryPath              | Полный путь к папке, в которой находятся скрипты миграции. Папка должна существовать.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Да         |
| -e          | --environment                      | Имя текущей среды, для которой будет выполняться миграция. Должно быть одним из значений указанных в секции доступных сред.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Да         |
| -m          | --mode                             | Режим запуска скриптов. OnlyCheck используется для проверки синтаксиса и проверки возможности запуска скриптов. Full используется для фактического выполнения скриптов.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Да         |
| -t          | --dbType                           | Тип базы данных. По умолчанию: MsSql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Нет        |
|             | --specifyingDatabaseNameValidation | True/False. По умолчанию - false. Если установлено значение true, все выражения в скрипте должны явно указывать, какую базу данных использовать. Например, для MSSQL скрипт вида: *SELECT * FROM MyTable* - будет ошибкой. *А USE [MyDb]; GO SELECT * FROM MyTable* - уже нет, так же как и *SELECT * FROM MyDb.dbo.MyTable*. По умолчанию, в качестве стандартной базы данных используется база, указанная в параметре databaseName, если она существует. Данный параметр может пригодится в случае, когда скрипты миграций применяются для разных баз и необходимо дополнительно валидировать для каких именно баз выполняется то или иное выражение. | Нет        |
|             | --backupPath                       | Путь к папке, в которой будут храниться полные резервные копии баз данных. Если путь указан и режим запуска Full, то при наличии новых сценариев миграций будут созданы резервные копии затронутых баз данных. Обратите внимание, что это путь к папке на сервере, на котором располагается база данных. В этой папке будут создаться папки с названием времени бэкапа, а внутри созданных папок будут располагаться бэкапы затронутых баз данных.                                                                                                                                                                                                      | Нет        |
|             | --from                             | Имя источника запуска. Например, PR или любая другая строка. Прописывается в каждый лог и служит дополнительным параметром для логгирования. По умолчанию: Unknown.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Нет        |

### Первые скрипты миграций для MSSQL

В MSSQL исполненные скрипты хранятся в таблице *__MigrationScripts*, поэтому в первом скрипте должно быть обязательно объявление этой таблицы.
``` sql
CREATE TABLE [__MigrationScripts] (
[Id] int NOT NULL,
[ScriptName] varchar(50) NOT NULL,
[AppliedAtUtc] datetime2 NOT NULL,
CONSTRAINT [PK_MigrationScripts] PRIMARY KEY ([Id])
);
```

Также перед созданием этой таблицы вы можете создать базу данных (не забудьте поместить в имя файла параметр NoTransaction, так как CREATE DATABASE не может быть исполнен с использованием транзакций):
``` sql
CREATE DATABASE NICEDB;
GO

CREATE TABLE NICEDB.dbo.[__MigrationScripts] (
    [Id] int NOT NULL,
    [ScriptName] varchar(50) NOT NULL,
    [AppliedAtUtc] datetime2 NOT NULL,
    CONSTRAINT [PK_MigrationScripts] PRIMARY KEY ([Id])
);
GO
```